<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Growsports LMS — Upgraded</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; transition: background .3s, color .3s; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.05); }
    .dark .glass { background: rgba(0,0,0,0.3); }
    .grid-autofill { display: grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap: 1rem; }
    .toast-enter { animation: toast-in .25s ease both; }
    @keyframes toast-in { from {opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
  </style>
</head>
<body class="dark bg-gray-950 text-gray-100">

<!-- Sidebar -->
<aside class="fixed inset-y-0 left-0 w-72 bg-gray-900 glass border-r border-white/10 p-4 z-40">
  <h1 class="text-xl font-bold mb-6">📘 Growsports LMS</h1>
  <nav class="space-y-2">
    <button data-route="dashboard" class="navlink w-full text-left px-3 py-2 rounded-lg hover:bg-white/10">🏠 Dashboard</button>
    <button data-route="catalog" class="navlink w-full text-left px-3 py-2 rounded-lg hover:bg-white/10">📚 Catalog</button>
    <button data-route="media" class="navlink w-full text-left px-3 py-2 rounded-lg hover:bg-white/10">🗂 Media Library</button>
    <button data-route="admin" class="navlink admin-only hidden w-full text-left px-3 py-2 rounded-lg hover:bg-white/10">🛠 Admin Panel</button>
  </nav>
  <div class="mt-6 border-t border-white/10 pt-4">
    <div id="userBlock" class="flex items-center gap-3 mb-3">
      <img id="userPhoto" class="w-10 h-10 rounded-full border border-white/10" src="" alt="">
      <div>
        <div id="userName" class="font-medium">Guest</div>
        <div id="userEmail" class="text-xs text-gray-400">guest@example.com</div>
      </div>
    </div>
    <button id="authButton" class="w-full bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg">Log In</button>
    <button id="logoutButton" class="hidden w-full bg-rose-600 hover:bg-rose-700 px-3 py-2 rounded-lg mt-2">Log Out</button>
  </div>
</aside>

<!-- Main -->
<div class="ml-72 p-6 space-y-8">
  <header class="flex justify-between items-center">
    <h2 id="breadcrumb" class="text-xl font-bold">Dashboard</h2>
    <button id="themeToggle" class="px-3 py-2 rounded-lg bg-white/10">🌙</button>
  </header>

  <!-- Dashboard -->
  <section id="page-dashboard">
    <h3 class="text-lg font-semibold mb-2">Enrolled Courses</h3>
    <div id="enrolledCourses" class="grid-autofill"></div>
  </section>

  <!-- Catalog -->
  <section id="page-catalog" class="hidden">
    <h3 class="text-lg font-semibold mb-2">Course Catalog</h3>
    <div id="catalogCourses" class="grid-autofill"></div>
  </section>

  <!-- Media Library -->
  <section id="page-media" class="hidden">
    <h3 class="text-lg font-semibold mb-2">Upload Media</h3>
    <input type="file" id="mediaUpload" class="mb-3"/>
    <progress id="uploadProgress" value="0" max="100" class="w-full mb-3"></progress>
    <div id="mediaList" class="grid-autofill"></div>
  </section>

  <!-- Admin -->
  <section id="page-admin" class="hidden">
    <h3 class="text-lg font-semibold mb-2">Add Course</h3>
    <input id="courseTitle" placeholder="Title" class="w-full mb-2 p-2 rounded text-black"/>
    <textarea id="courseDesc" placeholder="Description" class="w-full mb-2 p-2 rounded text-black"></textarea>
    <input id="courseThumb" placeholder="Thumbnail URL" class="w-full mb-2 p-2 rounded text-black"/>
    <input id="courseVideo" placeholder="Video URL (YouTube/Vimeo/Drive)" class="w-full mb-2 p-2 rounded text-black"/>
    <button id="addCourse" class="bg-emerald-600 px-3 py-2 rounded-lg">Add Course</button>
  </section>
</div>

<!-- Toasts -->
<div id="toasts" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

<script type="module">
  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_APP.firebaseapp.com",
    projectId: "YOUR_APP",
    storageBucket: "YOUR_APP.appspot.com",
    messagingSenderId: "XXXX",
    appId: "XXXX"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // --- Elements ---
  const pages = {
    dashboard: document.getElementById("page-dashboard"),
    catalog: document.getElementById("page-catalog"),
    media: document.getElementById("page-media"),
    admin: document.getElementById("page-admin")
  };
  const breadcrumb = document.getElementById("breadcrumb");
  const authBtn = document.getElementById("authButton");
  const logoutBtn = document.getElementById("logoutButton");
  const userName = document.getElementById("userName");
  const userEmail = document.getElementById("userEmail");
  const userPhoto = document.getElementById("userPhoto");

  // --- Navigation ---
  document.querySelectorAll(".navlink").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const route=btn.dataset.route;
      breadcrumb.textContent=btn.textContent.trim();
      Object.values(pages).forEach(p=>p.classList.add("hidden"));
      pages[route].classList.remove("hidden");
    });
  });

  // --- Auth ---
  authBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  logoutBtn.onclick=()=>auth.signOut();

  auth.onAuthStateChanged(user=>{
    if(user){
      authBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      userName.textContent=user.displayName||"Student";
      userEmail.textContent=user.email;
      userPhoto.src=user.photoURL||`https://ui-avatars.com/api/?name=${user.email[0]}`;
      loadCatalog();
      loadEnrolled(user.uid);
    }else{
      authBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      userName.textContent="Guest";
      userEmail.textContent="guest@example.com";
      userPhoto.src="";
    }
  });

  // --- Catalog ---
  function loadCatalog(){
    db.collection("courses").onSnapshot(snap=>{
      let html="";
      snap.forEach(doc=>{
        const c=doc.data();
        html+=`
        <div class="glass p-4 rounded-xl">
          <img src="${c.thumbnail}" class="w-full h-40 object-cover rounded mb-2"/>
          <h4 class="font-semibold">${c.title}</h4>
          <p class="text-sm text-gray-400">${c.description}</p>
          <button onclick="enroll('${doc.id}')" class="mt-2 bg-emerald-600 px-3 py-1 rounded">Enroll</button>
          <button onclick="playCourse('${c.videoUrl}')" class="mt-2 bg-indigo-600 px-3 py-1 rounded">Preview</button>
        </div>`;
      });
      document.getElementById("catalogCourses").innerHTML=html;
    });
  }

  // --- Enrollment ---
  window.enroll=(courseId)=>{
    const uid=auth.currentUser.uid;
    db.collection("users").doc(uid).collection("enrollments").doc(courseId).set({date:new Date()});
    toast("Enrolled ✅");
  };

  function loadEnrolled(uid){
    db.collection("users").doc(uid).collection("enrollments").onSnapshot(snap=>{
      let html="";
      snap.forEach(doc=>{
        html+=`<div class="glass p-4 rounded-xl">Course ID: ${doc.id}</div>`;
      });
      document.getElementById("enrolledCourses").innerHTML=html||"No enrollments yet";
    });
  }

  // --- Media Upload ---
  document.getElementById("mediaUpload").addEventListener("change",e=>{
    const file=e.target.files[0];
    if(!file) return;
    const ref=storage.ref("media/"+file.name);
    const task=ref.put(file);
    task.on("state_changed",s=>{
      document.getElementById("uploadProgress").value=(s.bytesTransferred/s.totalBytes)*100;
    },null,()=>toast("Upload complete ✅"));
  });

  // --- Admin Add Course ---
  document.getElementById("addCourse").onclick=()=>{
    const c={
      title:courseTitle.value,
      description:courseDesc.value,
      thumbnail:courseThumb.value,
      videoUrl:courseVideo.value
    };
    db.collection("courses").add(c).then(()=>toast("Course added ✅"));
  };

  // --- Video Player ---
  window.playCourse=(url)=>{
    let embed="";
    if(url.includes("youtube")) embed=`<iframe class="w-full h-64" src="${url.replace("watch?v=","embed/")}" allowfullscreen></iframe>`;
    else if(url.includes("vimeo")) embed=`<iframe class="w-full h-64" src="https://player.vimeo.com/video/${url.split("/").pop()}" allowfullscreen></iframe>`;
    else embed=`<video controls class="w-full h-64"><source src="${url}"></video>`;
    toast(embed,true);
  };

  // --- Theme Toggle ---
  document.getElementById("themeToggle").onclick=()=>document.body.classList.toggle("dark");

  // --- Toast ---
  function toast(msg,raw=false){
    const div=document.createElement("div");
    div.className="toast-enter glass p-3 rounded";
    div.innerHTML=raw?msg:`<div>${msg}</div>`;
    document.getElementById("toasts").appendChild(div);
    setTimeout(()=>div.remove(),4000);
  }
</script>
</body>
</html>
